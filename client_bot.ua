from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils import executor
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup
import requests

API_TOKEN = '7601039938:AAFBwVCYTOjPWq0PGMi4RWn9D7jPUpH1tgw'
ADMIN_BOT_TOKEN = '8025761375:AAFy7cXEiTrQUhF7_x3ks6qB6veQAJn_0yc'
ADMIN_CHAT_ID = 1354155194

bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot, storage=MemoryStorage())

class OrderForm(StatesGroup):
    choosing_payment = State()
    entering_name = State()
    entering_phone = State()
    entering_address = State()

menu = {
    "Ğ¡ÑƒĞºĞ½Ñ–": ["Ğ‘Ñ–Ğ»Ğµ Ğ¿Ğ»Ğ°Ñ‚Ñ‚Ñ ğŸ’« â€” 1200â‚´", "Ğ Ğ¾Ğ¶ĞµĞ²Ğµ Ğ¿Ğ»Ğ°Ñ‚Ñ‚Ñ ğŸŒ¸ â€” 1350â‚´", "ĞÑĞ´Ğ¾Ğ²Ğµ Ğ¿Ğ»Ğ°Ñ‚Ñ‚Ñ ğŸ‘ â€” 1100â‚´"]
}

cart = {}
orders = {}
order_id_map = {}
pending_choice = {}

main_kb = ReplyKeyboardMarkup(resize_keyboard=True)
main_kb.add("ğŸ› ĞœĞµĞ½Ñ", "ğŸ›’ ĞšĞ¾ÑˆĞ¸Ğº").add("ğŸ“¦ ĞœĞ¾Ñ— Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ")

after_size_kb = ReplyKeyboardMarkup(resize_keyboard=True)
after_size_kb.add("â• Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ‰Ğµ", "ğŸ›’ ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğ´Ğ¾ ĞºĞ¾ÑˆĞ¸ĞºĞ°")

payment_kb = ReplyKeyboardMarkup(resize_keyboard=True)
payment_kb.add("ğŸ’³ 100% Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°", "ğŸ’° 50% Ğ¿ĞµÑ€ĞµĞ´Ğ¿Ğ»Ğ°Ñ‚Ğ°", "ğŸ’µ 300â‚´ Ğ°Ğ²Ğ°Ğ½Ñ").add("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´")

item_details = {
    "Ğ‘Ñ–Ğ»Ğµ Ğ¿Ğ»Ğ°Ñ‚Ñ‚Ñ ğŸ’« â€” 1200â‚´": {
        "photo": "AgACAgIAAxkBAAPfaIv-f6gCK5_jVSM3f6UyDIxPRJMAAvzzMRury2FIAQ27gbmfas0BAAMCAAN5AAM2BA",
        "desc": "ĞÑ–Ğ¶Ğ½Ğµ Ğ±Ñ–Ğ»Ğµ Ğ¿Ğ»Ğ°Ñ‚Ñ‚Ñ, Ñ–Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğµ Ğ´Ğ»Ñ Ğ»Ñ–Ñ‚Ğ° â˜€ï¸",
    },
    "Ğ Ğ¾Ğ¶ĞµĞ²Ğµ Ğ¿Ğ»Ğ°Ñ‚Ñ‚Ñ ğŸŒ¸ â€” 1350â‚´": {
        "photo": "https://example.com/pink.jpg",
        "desc": "Ğ Ğ¾Ğ¼Ğ°Ğ½Ñ‚Ğ¸Ñ‡Ğ½Ğµ Ñ€Ğ¾Ğ¶ĞµĞ²Ğµ Ğ¿Ğ»Ğ°Ñ‚Ñ‚Ñ Ğ· Ğ»ĞµĞ³ĞºĞ¸Ğ¼ ÑˆĞ»ĞµĞ¹Ñ„Ğ¾Ğ¼ ğŸŒ·",
    },
    "ĞÑĞ´Ğ¾Ğ²Ğµ Ğ¿Ğ»Ğ°Ñ‚Ñ‚Ñ ğŸ‘ â€” 1100â‚´": {
        "photo": "https://example.com/nude.jpg",
        "desc": "Ğ›Ğ°ĞºĞ¾Ğ½Ñ–Ñ‡Ğ½Ğµ Ğ½ÑĞ´Ğ¾Ğ²Ğµ Ğ¿Ğ»Ğ°Ñ‚Ñ‚Ñ Ğ´Ğ»Ñ Ğ±ÑƒĞ´ÑŒ-ÑĞºĞ¾Ğ³Ğ¾ Ğ·Ğ°Ñ…Ğ¾Ğ´Ñƒ ğŸ€",
    }
}

def build_admin_kb(order_id: str):
    return InlineKeyboardMarkup(row_width=2).add(
        InlineKeyboardButton("âœ… ĞŸÑ€Ğ¸Ğ¹Ğ½ÑÑ‚Ğ¸", callback_data=f"approve_{order_id}"),
        InlineKeyboardButton("âŒ Ğ’Ñ–Ğ´Ñ…Ğ¸Ğ»Ğ¸Ñ‚Ğ¸", callback_data=f"reject_{order_id}")
    )

@dp.message_handler(commands=['start'])
async def start(msg: types.Message):
    await msg.answer("ĞŸÑ€Ğ¸Ğ²Ñ–Ñ‚, ĞºÑ€Ğ°ÑÑƒĞ½Ğµ! ğŸ‘— Ğ¯ â€” Ñ‚Ğ²Ñ–Ğ¹ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½ ÑÑ‚Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ´ÑĞ³Ñƒ Ñ– Ğ´Ğ¾Ğ¿Ğ¾Ğ¼Ğ¾Ğ¶Ñƒ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ. ĞĞ±ĞµÑ€Ğ¸ Ğ¾Ğ¿Ñ†Ñ–Ñ Ğ½Ğ¸Ğ¶Ñ‡Ğµ:", reply_markup=main_kb)

@dp.message_handler(lambda m: m.text == "ğŸ› ĞœĞµĞ½Ñ")
async def show_menu(msg: types.Message):
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    for cat in menu:
        kb.add(cat)
    kb.add("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´")
    await msg.answer("ĞĞ±ĞµÑ€Ğ¸ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ:", reply_markup=kb)

@dp.message_handler(lambda m: m.text in menu)
async def show_items(msg: types.Message):
    items = menu[msg.text]
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    for item in items:
        kb.add(item)
    kb.add("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´")
    await msg.answer("ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ Ñ‚Ğ¾Ğ²Ğ°Ñ€:", reply_markup=kb)

@dp.message_handler(lambda m: m.text in sum(menu.values(), []))
async def show_item_details(msg: types.Message):
    user_id = msg.from_user.id
    item = msg.text
    pending_choice[user_id] = item

    data = item_details.get(item)
    if not data:
        await msg.answer("Ğ¤Ğ¾Ñ‚Ğ¾ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğµ.")
    else:
        buttons = [
            [KeyboardButton("S"), KeyboardButton("M"), KeyboardButton("L")],
            [KeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´")]
        ]
        kb = ReplyKeyboardMarkup(resize_keyboard=True, keyboard=buttons)
        await msg.answer_photo(
            photo=data["photo"],
            caption=f"{data['desc']}

ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€:",
            reply_markup=kb
        )

@dp.message_handler(lambda m: m.text in ["S", "M", "L"])
async def choose_size(msg: types.Message):
    user_id = msg.from_user.id
    item = pending_choice.get(user_id)
    if not item:
        await msg.answer("â— Ğ¡Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ Ğ¾Ğ±ĞµÑ€Ñ–Ñ‚ÑŒ Ñ‚Ğ¾Ğ²Ğ°Ñ€.")
        return
    cart.setdefault(user_id, []).append(f"{item} (Ğ Ğ¾Ğ·Ğ¼Ñ–Ñ€ {msg.text})")
    del pending_choice[user_id]

    await msg.answer(f"âœ¨ Ğ”Ğ¾Ğ´Ğ°Ğ½Ğ¾ Ğ´Ğ¾ ĞºĞ¾ÑˆĞ¸ĞºĞ°: {item} (Ğ Ğ¾Ğ·Ğ¼Ñ–Ñ€ {msg.text})", reply_markup=after_size_kb)

@dp.message_handler(lambda m: m.text == "ğŸ›’ ĞšĞ¾ÑˆĞ¸Ğº")
async def show_cart(msg: types.Message):
    user_id = msg.from_user.id
    items = cart.get(user_id, [])
    if not items:
        await msg.answer("ĞšĞ¾ÑˆĞ¸Ğº Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ–Ğ¹ ğŸ§º")
        return
    text = "\n".join(f"{i+1}. {item}" for i, item in enumerate(items))
    await msg.answer(f"ğŸ›’ Ğ’Ğ°Ñˆ ĞºĞ¾ÑˆĞ¸Ğº:\n{text}\n\nĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚Ğ¸: /order")

@dp.message_handler(commands=['order'])
async def order_start(msg: types.Message, state: FSMContext):
    user_id = msg.from_user.id
    items = cart.get(user_id, [])
    if not items:
        await msg.answer("ĞšĞ¾ÑˆĞ¸Ğº Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ–Ğ¹!")
        return

    total = 0
    for i in items:
        # Extract price
        try:
            price_str = i.split('â€”')[-1].replace("â‚´", "").strip()
            total += int(price_str)
        except:
            pass

    summary = "\n".join(f"â€” {item}" for item in items)
    await state.update_data(cart=items)

    await OrderForm.choosing_payment.set()
    await msg.answer(f"ğŸ§¾ *ĞŸĞ¾Ñ‚Ğ¾Ñ‡Ğ½Ğµ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ:*\n{summary}\nğŸ’° *Ğ¡ÑƒĞ¼Ğ°:* {total}â‚´\n\nĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ ÑĞ¿Ğ¾ÑÑ–Ğ± Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¸:",
                     parse_mode="Markdown", reply_markup=payment_kb)

@dp.message_handler(lambda m: m.text == "ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", state='*')
async def go_back(msg: types.Message, state: FSMContext):
    current_state = await state.get_state()

    if current_state == OrderForm.entering_address.state:
        await OrderForm.entering_phone.set()
        await msg.answer("â¬…ï¸ Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ñƒ Ñ‰Ğµ Ñ€Ğ°Ğ·:")
    elif current_state == OrderForm.entering_phone.state:
        await OrderForm.entering_name.set()
        await msg.answer("â¬…ï¸ Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ñ–Ğ¼â€™Ñ Ñ‰Ğµ Ñ€Ğ°Ğ·:")
    elif current_state == OrderForm.entering_name.state:
        await OrderForm.choosing_payment.set()
        await msg.answer("â¬…ï¸ ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ ÑĞ¿Ğ¾ÑÑ–Ğ± Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¸ Ñ‰Ğµ Ñ€Ğ°Ğ·:", reply_markup=payment_kb)
    elif current_state == OrderForm.choosing_payment.state:
        await msg.answer("â†©ï¸ ĞĞ°Ğ·Ğ°Ğ´ Ğ´Ğ°Ğ»Ñ– Ğ½ĞµĞ¼Ğ¾Ğ¶Ğ»Ğ¸Ğ²Ğ¾.", reply_markup=main_kb)

@dp.message_handler(state=OrderForm.choosing_payment)
async def ask_name(msg: types.Message, state: FSMContext):
    await state.update_data(payment=msg.text)
    await OrderForm.entering_name.set()
    await msg.answer("Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ñ–Ğ¼â€™Ñ:", reply_markup=payment_kb)

@dp.message_handler(state=OrderForm.entering_name)
async def ask_phone(msg: types.Message, state: FSMContext):
    await state.update_data(name=msg.text)
    await OrderForm.entering_phone.set()
    await msg.answer("Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ñƒ:", reply_markup=payment_kb)

@dp.message_handler(state=OrderForm.entering_phone)
async def ask_address(msg: types.Message, state: FSMContext):
    await state.update_data(phone=msg.text)
    await OrderForm.entering_address.set()
    await msg.answer("Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ğ°Ğ´Ñ€ĞµÑÑƒ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸:", reply_markup=payment_kb)

@dp.message_handler(state=OrderForm.entering_address)
async def confirm_order(msg: types.Message, state: FSMContext):
    user_id = msg.from_user.id
    data = await state.get_data()
    items = data.get("cart", [])
    order = {
        "items": items,
        "payment": data["payment"],
        "name": data["name"],
        "phone": data["phone"],
        "address": msg.text,
        "status": "Ğ¾Ñ‡Ñ–ĞºÑƒÑ”"
    }
    orders.setdefault(user_id, []).append(order)
    order_id = f"{user_id}-{len(orders[user_id])}"
    order_id_map[order_id] = (user_id, len(orders[user_id]) - 1)
    cart[user_id] = []

    ext = "\n".join(items)
    await msg.answer(f"ğŸŒ¸ Ğ—Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¾!\nğŸ†” {order_id}\nğŸ“¦ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: Ğ¾Ñ‡Ñ–ĞºÑƒÑ”", reply_markup=main_kb)

    # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ±Ğ¾Ñ‚
    msg_text = f"ğŸ› ĞĞĞ’Ğ• Ğ—ĞĞœĞĞ’Ğ›Ğ•ĞĞĞ¯\nğŸ†” {order_id}\n{ext}\nğŸ‘¤ {data['name']}\nğŸ“ {data['phone']}\nğŸ  {msg.text}\nğŸ’³ {data['payment']}"
    url = f"https://api.telegram.org/bot{ADMIN_BOT_TOKEN}/sendMessage"
    requests.post(url, json={
        "chat_id": ADMIN_CHAT_ID,
        "text": msg_text
    })

    await state.finish()

@dp.message_handler(lambda m: m.text == "ğŸ“¦ ĞœĞ¾Ñ— Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ")
async def my_orders(msg: types.Message):
    user_id = msg.from_user.id
    user_orders = orders.get(user_id, [])
    if not user_orders:
        await msg.answer("Ğ£ Ğ²Ğ°Ñ Ñ‰Ğµ Ğ½ĞµĞ¼Ğ°Ñ” Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½ÑŒ.")
        return
    text = ""
    for i, o in enumerate(user_orders):
        items = "\n".join(f"â€” {item}" for item in o['items'])
        text += f"ğŸ› Ğ—Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ â„–{user_id}-{i+1}\n{items}\nğŸ’³ {o['payment']}\nğŸ“¦ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: *{o['status']}*\n\n"
    await msg.answer(text, parse_mode="Markdown")

@dp.message_handler(lambda m: m.text == "â• Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ‰Ğµ")
async def add_more(msg: types.Message):
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    for cat in menu:
        kb.add(cat)
    kb.add("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´")
    await msg.answer("ĞĞ±ĞµÑ€Ğ¸ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ:", reply_markup=kb)

@dp.message_handler(lambda m: m.text == "ğŸ›’ ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğ´Ğ¾ ĞºĞ¾ÑˆĞ¸ĞºĞ°")
async def go_to_cart(msg: types.Message):
    user_id = msg.from_user.id
    items = cart.get(user_id, [])
    if not items:
        await msg.answer("ĞšĞ¾ÑˆĞ¸Ğº Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ–Ğ¹ ğŸ§º")
        return
    text = "\n".join(f"{i+1}. {item}" for i, item in enumerate(items))
    await msg.answer(f"ğŸ›’ Ğ’Ğ°Ñˆ ĞºĞ¾ÑˆĞ¸Ğº:\n{text}\n\nĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚Ğ¸: /order")

@dp.message_handler(lambda m: m.text.startswith("/set_"))
async def select_status(msg: types.Message):
    # ĞĞ´Ğ¼Ñ–Ğ½ÑÑŒĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° â€” Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ´Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºÑƒ, ÑĞºÑ‰Ğ¾ Ñ…Ğ¾Ñ‡ĞµÑˆ
    pass

@dp.message_handler(lambda m: m.text == "ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´")
async def back(msg: types.Message):
    await msg.answer("ĞĞ±ĞµÑ€Ğ¸ Ğ¾Ğ¿Ñ†Ñ–Ñ Ğ½Ğ¸Ğ¶Ñ‡Ğµ:", reply_markup=main_kb)

if __name__ == '__main__':
    from aiogram import executor
    executor.start_polling(dp, skip_updates=True)
